@import play.api.Play.current

@(message: String, game: GameController)(implicit session: play.api.mvc.Session)

@main("Playing against other Player") {

    @if(session.get("id").getOrElse(null) == game.players(0).playerID){
        @if(game.gameState.isPlayersTurn(game.players(0))){
            <div id="status" >
            @message
            </div>
        }else{
            <meta http-equiv="refresh" content="0; URL=@routes.Application.waiting">
            <div id="status_locked" >
            @message
            </div>
        }
    }else {
        @if(session.get("id").getOrElse(null) == game.players(1).playerID) {
            @if(game.gameState.isPlayersTurn(game.players(1))){
                <div id="status" >
                @message
                </div>
            }else{
                <meta http-equiv="refresh" content="0; URL=@routes.Application.waiting">
                <div id="status_locked" >
                @message
                </div>
            }
        }
    }


        <script language="javascript">
            var fieldSize = @game.fieldSize; // size of the field
            var boatLength = @{game.gameState.getNextBoatLength}; // length of the boat
            var boatStart = null; // first selected coordinate of the boat

            /** function to submit data via POST */
            function submitData(path, params) {
                var form = document.createElement("form");
                form.setAttribute("method", "POST");
                form.setAttribute("action", path);

                for(var key in params) {
                    if(params.hasOwnProperty(key)) {
                        var hiddenField = document.createElement("input");
                        hiddenField.setAttribute("type", "hidden");
                        hiddenField.setAttribute("name", key);
                        hiddenField.setAttribute("value", params[key]);
                        form.appendChild(hiddenField);
                    }
                }

                document.body.appendChild(form);
                form.submit();
            }

            /** getElementsByClassName function (not available for all browsers) */
            function getElementsByClassName(node,classname) {
                if (node.getElementsByClassName) { // use native implementation if available
                return node.getElementsByClassName(classname);
                } else {
                return (function getElementsByClass(searchClass,node) {
                if ( node == null )
                node = document;
                var classElements = [],
                els = node.getElementsByTagName("*"),
                elsLen = els.length,
                pattern = new RegExp("(^|\\s)"+searchClass+"(\\s|$)"), i, j;

                for (i = 0, j = 0; i < elsLen; i++) {
                if ( pattern.test(els[i].className) ) {
                classElements[j] = els[i];
                j++;
                }
                }
                return classElements;
                })(classname, node);
                }
            }

            /** function to place a boat by selecting two coordinates */
            function placeBoat(x,y) {
                var player = '@session.get("id").getOrElse(null)';
                if (boatStart == null) {
                    boatStart = new Array(x,y);
                } else {
                    if (x == boatStart[0] && y == boatStart[1] ) { // same coordinates: remove the first point
                        boatStart = null ;
                    } else if ( x == boatStart[0] && Math.abs(y - boatStart[1]) < boatLength) { // vertical placement
                        if (y > boatStart[1]) {
                            if (boatStart[1] + boatLength - 1 >= fieldSize) return;
                        } else {
                            if (boatStart[1] - boatLength + 1 < 0) return;
                            boatStart[1] = boatStart[1] - boatLength + 1;
                        }
                        submitData('@routes.Application.placeBoat',{'player': player, 'x': boatStart[0], 'y': boatStart[1], 'boatLength': boatLength, 'orientation': 'v'});
                    } else if ( y == boatStart[ 1 ] && Math.abs(x - boatStart[0]) < boatLength) { // horizontal placement
                        if (x > boatStart[0]) {
                            if (boatStart[0] + boatLength - 1 >= fieldSize) return;
                        } else {
                            if (boatStart[0] - boatLength + 1 < 0) return;
                            boatStart[0] = boatStart[0] - boatLength + 1;
                        }
                        submitData('@routes.Application.placeBoat',{'player': player, 'x': boatStart[0], 'y': boatStart[1], 'boatLength': boatLength, 'orientation': 'h'});
                    }
                }
            }

            /** mouseover-function for the boat-placement field */
            function placementMouseEvent(element,x,y) {
                resetHighlights();
                //console.log(element);
                if (boatStart == null) {
                    element.style.backgroundColor = "#00F";//"blue";//"rgb(0,0,255)";//"#00F";
                } else {
                    if (x == boatStart[ 0 ] && y == boatStart[ 1 ] ) { // same coordinates: remove the first point
                        element.style.backgroundColor = "#F00";
                    } else if ( x == boatStart[ 0 ] && Math.abs(y - boatStart[1]) < boatLength) { // vertical placement
                        var first = boatStart[1];
                        var last = boatStart[1] + boatLength - 1;
                        if (y < boatStart[1]) {
                            first = boatStart[1] - boatLength + 1;
                            last = boatStart[1];
                        }
                        if (first < 0 || first >= fieldSize || last < 0 || last >= fieldSize) return
                        for ( var i=first ; i <= last; i ++ ) {
                            document.getElementById("own_cell_"+x+"_"+i).style.backgroundColor = "#0F0";//"green";//"rgb(0,255,0)";//"#0F0";
                            //console.log(document.getElementById("own_cell_"+x+"_"+i));
                        }
                    } else if ( y == boatStart[ 1 ] && Math.abs(x - boatStart[0]) < boatLength) { // horizontal placement
                        var first = boatStart[0];
                        var last = boatStart[0] + boatLength - 1;
                        if (x < boatStart[0]) {
                            first = boatStart[0] - boatLength + 1;
                            last = boatStart[0];
                        }
                        if (first < 0 || first >= fieldSize || last < 0 || last >= fieldSize) return
                        for ( var i=first ; i <= last; i ++ ) {
                            document.getElementById("own_cell_"+i+"_"+y).style.backgroundColor = "#0F0";//"green";//"rgb(0,255,0)";//"#0F0";
                            //console.log(document.getElementById("own_cell_"+i+"_"+y));
                        }
                    }
                }
            }

            /** reset all the cell colors */
            function resetHighlights() {
                var elements = getElementsByClassName(document, "own_cell");
                for (var i = 0; i < elements.length; i++) {
                    if (boatStart != null && elements[i].id == "own_cell_"+boatStart[0]+"_"+boatStart[1]) {
                        elements[i].style.backgroundColor = "#FF0" ;
                    } else {
                        elements[i].style.backgroundColor = "#DDD" ;
                    }
                }
            }

            /** function to shoot at a coordinate */
            function shoot(x,y) {
                var player = '@session.get("id").getOrElse(null)';
                //alert('Shoot at '+x+','+y);
                submitData('@routes.Application.shoot',{'player': player, 'x': x, 'y': y})
            }

        </script>


    @{
        //val player : RemotePlayer = Cache.getAs[RemotePlayer]("player1").getOrElse(null)
    }

    @*
    @ownFieldState() = @{ if(session.get("name") == game.players(0).playerName) game.gameState.fieldState1 else game.gameState.fieldState2 }
    @opponentFieldState() = @{ if(session.get("name") == game.players(0).playerName) game.gameState.fieldState2 else game.gameState.fieldState1 }
    *@

    @*
    @{ val ownFieldState = { if(session.get("name") == game.players(0).playerName) game.gameState.fieldState1 else game.gameState.fieldState2 }}
    @{ val opponentFieldState = { if(session.get("name") == game.players(0).playerName) game.gameState.fieldState2 else game.gameState.fieldState1 }}
    *@


    <!-- Unterscheidung zwischen Spieler 1 und 2 -->
    <div id="monitor_container">
        @if(session.get("id").getOrElse(null) == game.players(0).playerID){
            <div id="monitor_own">
                <span>@game.players(0).playerName</span>
                <table id="own_game_area" class="game_area"  onmouseout="resetHighlights()">
                @for(y <- 0 until game.fieldSize) {
                    <tr>
                    @for(x <- 0 until game.fieldSize) {
                        <td id="own_cell_@{x}_@y" class="own_cell" onclick="placeBoat(@x,@y)" onmouseenter="placementMouseEvent(this,@x,@y)">
                        @if(game.gameState.fieldState1.visualCells(x)(y) == 0){
                            @if(game.gameState.fieldState1.gameArea.cells(x)(y) != 0) {
                                O
                            } else {
                                &nbsp;
                            }
                        }else{
                            @if(game.gameState.fieldState1.visualCells(x)(y) == 1) {
                                X
                            } else {
                                *
                            }
                        }
                        </td>
                    }
                    </tr>
                }
                </table>
            </div>
            <div id="monitor_opponent">
                <span>@game.players(1).playerName</span>
                <table id="opponent_game_area" class="game_area">
                @for(y <- 0 until game.fieldSize) {
                    <tr>
                    @for(x <- 0 until game.fieldSize) {
                        <td id="opponent_cell_@{x}_@y"  onclick="shoot(@x,@y)">
                            @if(game.gameState.fieldState2.visualCells(x)(y) != 0) {
                                @if(game.gameState.fieldState2.visualCells(x)(y) == 1) {
                                    X
                                } else {
                                    *
                                }
                            } else {
                                &nbsp;
                            }
                        </td>
                    }
                    </tr>
                }
                </table>
            </div>
        }else {
            <div id="monitor_own">
                <span>@game.players(1).playerName</span>
                <table id="own_game_area" class="game_area"  onmouseout="resetHighlights()">
                @if(session.get("id").getOrElse(null) == game.players(1).playerID) {
                    @for(y <- 0 until game.fieldSize) {
                        <tr>
                        @for(x <- 0 until game.fieldSize) {
                            <td id="own_cell_@{x}_@y" class="own_cell" onclick="placeBoat(@x,@y)" onmouseenter="placementMouseEvent(this,@x,@y)">
                            @if(game.gameState.fieldState2.visualCells(x)(y) == 0){
                                @if(game.gameState.fieldState2.gameArea.cells(x)(y) != 0) {
                                    O
                                } else {
                                    &nbsp;
                                }
                            }else {
                                @if(game.gameState.fieldState2.visualCells(x)(y) == 1) {
                                    X
                                } else {
                                    *
                                }
                             }
                            </td>
                        }
                        </tr>
                    }
                }
                </table>
            </div>
            <div id="monitor_opponent">
                <span>@game.players(0).playerName</span>
                <table id="opponent_game_area" class="game_area">
                @for(y <- 0 until game.fieldSize) {
                    <tr>
                    @for(x <- 0 until game.fieldSize) {
                        <td id="opponent_cell_@{x}_@y"  onclick="shoot(@x,@y)">
                            @if(game.gameState.fieldState1.visualCells(x)(y) != 0) {
                                @if(game.gameState.fieldState1.visualCells(x)(y) == 1) {
                                    X
                                } else {
                                    *
                                }
                            } else {
                                &nbsp;
                            }
                        </td>
                    }
                    </tr>
                }
                </table>
            </div>
        }
    </div>

    @if(session.get("id").getOrElse(null) == game.players(0).playerID){
        @if(game.gameState.isPlayersTurn(game.players(0))){
            <a href="@routes.Application.endGame" >Spiel aufgeben!!</a>
        }
    }else {
        @if(session.get("id").getOrElse(null) == game.players(1).playerID) {
            @if(game.gameState.isPlayersTurn(game.players(1))){
                <a href="@routes.Application.endGame" >Spiel aufgeben!!</a>
            }
        }
    }
}
